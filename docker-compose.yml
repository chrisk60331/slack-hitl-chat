version: '3.8'

services:
  # Local DynamoDB for testing
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: agentcore-dynamodb-local
    expose:
      - "8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory"]
    networks:
      - agentcore-local

  # Execute Lambda for testing
  approval-lambda:
    build:
      context: .
      dockerfile: Dockerfile
      target: approval
    container_name: agentcore-approval-local
    env_file: .env
    environment:
      # Lambda runtime simulation
      - LAMBDA_TASK_ROOT=/var/task
      - _HANDLER=src.execute_handler.lambda_handler
      - TABLE_NAME=agentcore-dev-approval-log
      - CONFIG_TABLE_NAME=agentcore-dev-config
      - AWS_DEFAULT_REGION=us-west-2
      - PYTHONPATH=/var/task:/opt/google_mcp
      - LOG_LEVEL=DEBUG
    ports:
      - "9000:8080"  # Lambda Runtime Interface Emulator port
    volumes:
      - ./tests:/var/task/tests:ro
      - ./.env:/var/task/.env:ro
      - ~/.aws:/root/.aws:ro
      - .env:/var/task/.env:ro
    networks:
      - agentcore-local
    # Use the default Lambda entrypoint with handler as argument
    command: ["src.approval_handler.lambda_handler"]
  # Execute Lambda for testing
  execute-lambda:
    build:
      context: .
      dockerfile: Dockerfile
      target: execute
    container_name: agentcore-execute-local
    env_file: .env
    environment:
      # Lambda runtime simulation
      - LAMBDA_TASK_ROOT=/var/task
      - _HANDLER=src.execute_handler.lambda_handler
      - TABLE_NAME=agentcore-dev-approval-log
      - CONFIG_TABLE_NAME=agentcore-dev-config
      - AWS_DEFAULT_REGION=us-west-2
      - PYTHONPATH=/var/task:/opt/google_mcp
      - LOG_LEVEL=DEBUG
    ports:
      - "9000:8080"  # Lambda Runtime Interface Emulator port
    volumes:
      - ./tests:/var/task/tests:ro
      - ./.env:/var/task/.env:ro
      - ~/.aws:/root/.aws:ro
    networks:
      - agentcore-local
    # Use the default Lambda entrypoint with handler as argument
    command: ["src.execute_handler.lambda_handler"]

  # Test runner container (separate from lambda runtime)
  api-lambda:
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    container_name: agentcore-api-local
    env_file: .env
    environment:
      # Lambda runtime simulation
      - LAMBDA_TASK_ROOT=/var/task
      - _HANDLER=src.execute_handler.lambda_handler
      - TABLE_NAME=agentcore-dev-approval-log
      - CONFIG_TABLE_NAME=agentcore-dev-config
      - AWS_DEFAULT_REGION=us-west-2
      - PYTHONPATH=/var/task:/opt/google_mcp
      - LOG_LEVEL=DEBUG
      - AWS_LAMBDA_FUNCTION_NAME=api
    ports:
      - "9000:8080"  # Lambda Runtime Interface Emulator port
    volumes:
      - ./.env:/var/task/.env:ro
      - ~/.aws:/root/.aws:ro
    networks:
      - agentcore-local
    # Use the default Lambda entrypoint with handler as argument
    command: ["src.api.handler"]

networks:
  agentcore-local:
    driver: bridge